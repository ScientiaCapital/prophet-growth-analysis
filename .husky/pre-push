#!/bin/sh

# Pre-push hook for Prophet Analytics
# Final quality gate before pushing to GitHub

echo "üöÄ Running pre-push checks..."

# 1. Run all tests
echo "üß™ Running full test suite..."
npm test
if [ $? -ne 0 ]; then
  echo "‚ùå Tests failed. Cannot push to remote."
  exit 1
fi

# 2. Check test coverage
echo "üìä Checking test coverage..."
npm run test:coverage
if [ $? -ne 0 ]; then
  echo "‚ùå Test coverage below threshold. Cannot push to remote."
  exit 1
fi

# 3. Security audit
echo "üîí Running security audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo "‚ùå High severity vulnerabilities found. Please fix before pushing."
  exit 1
fi

# 4. Python security check (if backend files changed)
# Check if origin/main exists, if not skip the diff check
if git rev-parse --verify origin/main >/dev/null 2>&1; then
  if git diff --name-only origin/main...HEAD | grep -q "apps/backend-api/.*\.py$"; then
  echo "üêç Running Python security checks..."
  cd apps/backend-api
  
  # Bandit security scan
  poetry run bandit -r src/
  if [ $? -ne 0 ]; then
    echo "‚ùå Security vulnerabilities found in Python code."
    exit 1
  fi
  
  # Safety check for dependencies
  poetry run safety check
  if [ $? -ne 0 ]; then
    echo "‚ùå Vulnerable Python dependencies found."
    exit 1
  fi
  
  cd ../..
  fi
fi

# 5. Build verification
echo "üèóÔ∏è Verifying builds..."
npm run build
if [ $? -ne 0 ]; then
  echo "‚ùå Build failed. Cannot push to remote."
  exit 1
fi

# 6. Final TypeScript check
echo "üìò Final TypeScript verification..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript errors found. Cannot push to remote."
  exit 1
fi

# 7. Lint check
echo "üîç Final lint check..."
npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå Linting errors found. Cannot push to remote."
  exit 1
fi

# 8. Verify README sanitization
echo "ü§´ Verifying README files are sanitized..."
node scripts/verify-readme-sanitized.js
if [ $? -ne 0 ]; then
  echo "‚ùå README files contain sensitive information. Cannot push to remote."
  exit 1
fi

# 9. Check branch protection
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  # Check if this is the first push
  if ! git rev-parse --verify origin/$CURRENT_BRANCH >/dev/null 2>&1; then
    echo "üìù First push to $CURRENT_BRANCH branch detected. Allowing initial setup..."
  else
    echo "‚ö†Ô∏è  Warning: Pushing directly to $CURRENT_BRANCH branch."
    echo "Consider creating a feature branch and pull request."
    read -p "Are you sure you want to continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      echo "‚ùå Push cancelled."
      exit 1
    fi
  fi
fi

echo "‚úÖ All pre-push checks passed! Pushing to remote..."