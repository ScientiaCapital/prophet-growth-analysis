#!/bin/sh

# Pre-push hook for Prophet Analytics
# Final quality gate before pushing to GitHub

echo "ğŸš€ Running pre-push checks..."

# 1. Run all tests
echo "ğŸ§ª Running full test suite..."
npm test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Cannot push to remote."
  exit 1
fi

# 2. Check test coverage
echo "ğŸ“Š Checking test coverage..."
npm run test:coverage
if [ $? -ne 0 ]; then
  echo "âŒ Test coverage below threshold. Cannot push to remote."
  exit 1
fi

# 3. Security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
  echo "âŒ High severity vulnerabilities found. Please fix before pushing."
  exit 1
fi

# 4. Python security check (if backend files changed)
if git diff --name-only origin/main...HEAD | grep -q "apps/backend-api/.*\.py$"; then
  echo "ğŸ Running Python security checks..."
  cd apps/backend-api
  
  # Bandit security scan
  poetry run bandit -r src/
  if [ $? -ne 0 ]; then
    echo "âŒ Security vulnerabilities found in Python code."
    exit 1
  fi
  
  # Safety check for dependencies
  poetry run safety check
  if [ $? -ne 0 ]; then
    echo "âŒ Vulnerable Python dependencies found."
    exit 1
  fi
  
  cd ../..
fi

# 5. Build verification
echo "ğŸ—ï¸ Verifying builds..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Cannot push to remote."
  exit 1
fi

# 6. Final TypeScript check
echo "ğŸ“˜ Final TypeScript verification..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript errors found. Cannot push to remote."
  exit 1
fi

# 7. Lint check
echo "ğŸ” Final lint check..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting errors found. Cannot push to remote."
  exit 1
fi

# 8. Verify README sanitization
echo "ğŸ¤« Verifying README files are sanitized..."
node scripts/verify-readme-sanitized.js
if [ $? -ne 0 ]; then
  echo "âŒ README files contain sensitive information. Cannot push to remote."
  exit 1
fi

# 9. Check branch protection
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "âš ï¸  Warning: Pushing directly to $CURRENT_BRANCH branch."
  echo "Consider creating a feature branch and pull request."
  read -p "Are you sure you want to continue? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Push cancelled."
    exit 1
  fi
fi

echo "âœ… All pre-push checks passed! Pushing to remote..."